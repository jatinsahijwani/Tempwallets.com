generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String?  @unique
  googleId    String?  @unique
  fingerprint String?  @unique
  name        String?
  picture     String?
  createdAt   DateTime @default(now())
  lastLoginAt DateTime @updatedAt
  wallets     Wallet[]

  @@index([googleId])
  @@index([fingerprint])
}

model Wallet {
  id               String          @id @default(cuid())
  userId           String
  salt             String
  encryptedSeed    String
  encryptedEntropy String
  createdAt        DateTime        @default(now())
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  addresses        WalletAddress[]
  aptosAccounts    AptosAccount[]

  @@index([userId])
}

model WalletAddress {
  id        String   @id @default(cuid())
  walletId  String
  chain     String
  address   String
  createdAt DateTime @default(now())
  wallet    Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, chain])
  @@index([walletId])
  @@index([address])
}

model WalletSeed {
  id         String   @id @default(cuid())
  userId     String   @unique
  ciphertext String
  iv         String
  authTag    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

// Stores wallet history for authenticated users (Google login)
// Allows users to switch between previously created wallets
model WalletHistory {
  id         String   @id @default(cuid())
  userId     String   // Google user ID
  label      String?  // User-friendly name like "Wallet 1", "Savings", etc.
  ciphertext String   // Encrypted seed phrase
  iv         String
  authTag    String
  isActive   Boolean  @default(false) // Only one wallet should be active per user
  createdAt  DateTime @default(now())
  
  @@index([userId])
  @@index([userId, isActive])
  @@map("wallet_history")
}

model WalletCache {
  id             String   @id @default(cuid())
  fingerprint    String   @unique
  cachedBalances Json
  lastUpdated    DateTime @default(now()) @updatedAt
  createdAt      DateTime @default(now())

  @@index([fingerprint])
  @@map("wallet_cache")
}

model WalletAddressCache {
  id          String   @id @default(cuid())
  fingerprint String
  chain       String
  address     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([fingerprint, chain])
  @@index([fingerprint])
  @@index([chain])
  @@map("wallet_address_cache")
}

model AptosAccount {
  id             String   @id @default(cuid())
  walletId       String
  address        String   // Normalized (lowercase, 0x + 64 hex chars)
  publicKey      String
  sequenceNumber Int      @default(0)
  network        String   // 'mainnet' | 'testnet' | 'devnet'
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  wallet         Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, network])
  @@unique([address, network])
  @@index([walletId])
  @@index([address])
  @@map("aptos_account")
}

// EIP-7702 Delegation tracking
// Records when an EOA has signed authorization for gasless transactions
model Eip7702Delegation {
  id                String   @id @default(cuid())
  walletId          String   // User's wallet ID (from Wallet or fingerprint)
  address           String   // EOA address (lowercase, 0x + 40 hex chars)
  chainId           Int      // EVM chain ID
  delegationAddress String   // Smart account implementation address
  authorizedAt      DateTime @default(now()) // When authorization was signed
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([walletId, chainId])
  @@index([address, chainId])
  @@index([walletId])
  @@map("eip7702_delegation")
}
